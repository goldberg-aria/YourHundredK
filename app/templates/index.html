<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What's Your Hundred K</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/css/output.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- 네비게이션 바 -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-2xl font-bold text-gray-900">What'sYourHundredK</h1>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium">
                            로그인
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">투자 시뮬레이션</h2>
                    <!-- 싱글/컴페어 모드 탭 -->
                    <div class="flex mb-6">
                        <button id="singleTab" onclick="setMode('single')" class="flex-1 py-2 rounded-l-md text-sm font-medium border border-blue-500 text-blue-500 bg-white hover:bg-blue-50">싱글</button>
                        <button id="compareTab" onclick="setMode('compare')" class="flex-1 py-2 rounded-r-md text-sm font-medium border border-blue-500 text-blue-500 bg-white hover:bg-blue-50">컴페어</button>
                    </div>
                    <!-- 입력 폼 -->
                    <div id="singleForm" class="grid grid-cols-1 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">종목 선택</label>
                            <select id="ticker" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" onchange="updateFullName()">
                                <option value="TSLA">TSLA</option>
                                <option value="TSLY">TSLY</option>
                                <option value="KO">KO</option>
                                <option value="SCHD">SCHD</option>
                            </select>
                            <div id="ticker-fullname" class="mt-1 text-xs text-gray-500"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">투자 금액 ($)</label>
                            <input type="number" id="investment_amount" value="100000" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">투자 시작일</label>
                            <input type="date" id="start_date" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">투자 종료일 (선택)</label>
                            <input type="date" id="end_date" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <button onclick="calculate()" 
                                    class="w-full bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                계산하기
                            </button>
                        </div>
                        <div>
                            <button onclick="refreshData()" 
                                    class="w-full bg-gray-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                새로고침 (전체 데이터 갱신)
                            </button>
                        </div>
                    </div>
                    <div id="compareForm" class="grid grid-cols-1 gap-6 mb-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">종목1</label>

                    <!-- 오류 메시지 -->
                    <div id="error" class="hidden mt-4 p-4 bg-red-50 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800" id="error-message"></h3>
                            </div>
                        </div>
                    </div>

                    <!-- 로딩 표시 -->
                    <div id="loading" class="hidden">
                        <div class="flex justify-center items-center py-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <span class="ml-2 text-gray-600">데이터를 가져오는 중...</span>
                        </div>
                    </div>

                    <!-- 결과 표시 영역 -->
                    <div id="results" class="hidden">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">투자 결과</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div id="resultContent" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            <div id="chart" class="mt-6"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const tickerFullNames = {
            'TSLA': 'Tesla Inc.',
            'TSLY': 'Global X Autonomous & Electric Vehicles ETF',
            'KO': 'Coca-Cola Company',
            'SCHD': 'Schwab US Dividend Equity ETF'
        };

        function updateFullName() {
            const ticker = document.getElementById('ticker').value;
            const fullNameDiv = document.getElementById('ticker-fullname');
            fullNameDiv.textContent = tickerFullNames[ticker] || '';
        }

        // 페이지 로드 시 날짜 기본값 설정
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // 날짜 입력 필드의 최대값을 어제로 설정
            const maxDate = yesterday.toISOString().split('T')[0];
            document.getElementById('start_date').max = maxDate;
            document.getElementById('end_date').max = maxDate;
            
            // 시작일을 1년 전으로 설정
            const lastYear = new Date(yesterday);
            lastYear.setFullYear(lastYear.getFullYear() - 1);
            document.getElementById('start_date').value = lastYear.toISOString().split('T')[0];
            
            // 종료일을 어제로 설정
            document.getElementById('end_date').value = maxDate;
            
            // 시작일이 변경될 때 종료일 제한
            document.getElementById('start_date').addEventListener('change', function(e) {
                const startDate = new Date(e.target.value);
                const endDateInput = document.getElementById('end_date');
                endDateInput.min = e.target.value;
                
                // 종료일이 시작일보다 이전이면 종료일을 시작일로 설정
                if (new Date(endDateInput.value) < startDate) {
                    endDateInput.value = e.target.value;
                }
            });
            
            // 종료일이 변경될 때 시작일 제한
            document.getElementById('end_date').addEventListener('change', function(e) {
                const endDate = new Date(e.target.value);
                const startDateInput = document.getElementById('start_date');
                startDateInput.max = e.target.value;
                
                // 시작일이 종료일보다 이후면 시작일을 종료일로 설정
                if (new Date(startDateInput.value) > endDate) {
                    startDateInput.value = e.target.value;
                }
            });

            updateFullName(); // 페이지 로드 시 풀네임 표시
        });

        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.add('hidden');
        }

        async function calculate() {
            const ticker = document.getElementById('ticker').value;
            const investment_amount = document.getElementById('investment_amount').value;
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            hideError();
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            
            try {
                // 먼저 데이터 가져오기
                const fetchResponse = await fetch('/api/fetch-stock-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, start_date, end_date })
                });

                const fetchData = await fetchResponse.json();
                if (!fetchResponse.ok) {
                    throw new Error(fetchData.error || '데이터를 가져오는데 실패했습니다.');
                }
                
                // 수익률 계산
                const response = await fetch('/api/calculate-returns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, investment_amount, start_date, end_date })
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || '수익률 계산에 실패했습니다.');
                }
                
                displayResults(data);
            } catch (error) {
                showError(error.message);
                console.error('Error:', error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function refreshData() {
            const ticker = document.getElementById('ticker').value;
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            hideError();
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            try {
                const fetchResponse = await fetch('/api/fetch-stock-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, start_date, end_date, force_refresh: true })
                });
                const fetchData = await fetchResponse.json();
                if (!fetchResponse.ok) {
                    throw new Error(fetchData.error || '데이터를 새로고침하는데 실패했습니다.');
                }
                loading.classList.add('hidden');
                alert('데이터가 새로고침되었습니다! 다시 계산하기를 눌러주세요.');
            } catch (error) {
                showError(error.message);
                loading.classList.add('hidden');
            }
        }

        function displayResults(data) {
            const results = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');
            const chart = document.getElementById('chart');
            
            results.classList.remove('hidden');
            
            resultContent.innerHTML = `
                <div class="stat-card">
                    <h4 class="font-medium text-gray-900">보유 주식 수</h4>
                    <p class="text-2xl font-semibold text-blue-600">${data.shares_owned.toLocaleString()} 주</p>
                </div>
                <div class="stat-card">
                    <h4 class="font-medium text-gray-900">총 배당금</h4>
                    <p class="text-2xl font-semibold text-green-600">$${data.total_dividends.toLocaleString()}</p>
                </div>
                <div class="stat-card">
                    <h4 class="font-medium text-gray-900">초기 투자금</h4>
                    <p class="text-2xl font-semibold text-gray-900">$${data.initial_investment.toLocaleString()}</p>
                </div>
                <div class="stat-card">
                    <h4 class="font-medium text-gray-900">현재 가치</h4>
                    <p class="text-2xl font-semibold text-blue-600">$${data.current_value.toLocaleString()}</p>
                </div>
                <div class="stat-card col-span-2">
                    <h4 class="font-medium text-gray-900">총 수익률</h4>
                    <p class="text-2xl font-semibold ${data.total_return_percentage >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${data.total_return_percentage.toLocaleString()}%
                    </p>
                </div>
            `;
            
            chart.innerHTML = data.chart;
        }
    </script>
</body>
</html> 